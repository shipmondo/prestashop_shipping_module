{#**
 * @author    Shipmondo <support@shipmondo.com>
 * @copyright 2024-present Shipmondo
 * @license   https://opensource.org/license/bsd-3-clause BSD-3-Clause
 *#}

{% extends '@PrestaShop/Admin/layout.html.twig' %}
{% form_theme form '@PrestaShop/Admin/TwigTemplateForm/prestashop_ui_kit.html.twig' %}

{% block content %}
    {{ form_start(form) }}
    <div class="card">
        <h3 class="card-header">
            <i class="material-icons">settings</i> {{ 'Shipmondo carrier'|trans({}, 'Modules.Shipmondo.Admin') }}
        </h3>

        <div class="card-body">
            <div class="form-wrapper">
                {{ form_widget(form) }}
            </div>
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary">{{ 'Save'|trans({}, 'Admin.Actions') }}</button>
            </div>
        </div>
    </div>
    {{ form_end(form) }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        const form = $('form[name=shipmondo_carrier_form]');
        const psCarrierSelect = form.find('#shipmondo_carrier_form_carrier_id');
        const carriersSelect = form.find('#shipmondo_carrier_form_carrier_code');
        const productsSelect = form.find('#shipmondo_carrier_form_product_code');
        const carrierProductsSelect = form.find('#shipmondo_carrier_form_carrier_product_code');
        const servicePointTypesSelect = form.find('#shipmondo_carrier_form_service_point_types');

        {% if isEdit %}
            psCarrierSelect.attr('disabled', true);
            psCarrierSelect.parent().append('<input type="hidden" name="shipmondo_carrier_form[carrier_id]" value="' + psCarrierSelect.val() + '" />');
        {% endif %}

        const fetchDataActionPath = '{{ fetchDataAction }}';

        async function fetchCarrierFields() {
            const carrierCode = carriersSelect.val() || null;
            const productCode = productsSelect.val() || null;

            const isServicePointDelivery = productCode === 'service_point';

            const carrierProductCode = isServicePointDelivery ? carrierProductsSelect.val() || null : null;
            const servicePointTypes =
                isServicePointDelivery && carrierProductCode ? servicePointTypesSelect.val() || null : null;

            return fetch(fetchDataActionPath, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    carrier_code: carrierCode,
                    product_code: productCode,
                    carrier_product_code: carrierProductCode,
                    service_point_types: servicePointTypes,
                }),
            }).then((res) => res.json());
        }

        function updateProductCodeOptions(choices, value) {
            productsSelect.empty();

            for (const [text, value] of Object.entries(choices)) {
                productsSelect.append($('<option></option>').attr('value', value).text(text));
            }

            productsSelect.val(value ?? null);
        }

        function updateCarrierProductCodeOptions(choices, value) {
            carrierProductsSelect.empty();

            if (productsSelect.val() === 'service_point') {
                carrierProductsSelect.parent().parent().show();
            } else {
                carrierProductsSelect.parent().parent().hide();
                return;
            }

            for (const [text, value] of Object.entries(choices)) {
                carrierProductsSelect.append($('<option></option>').attr('value', value).text(text));
            }

            carrierProductsSelect.val(value ?? null);
        }

        function updateServicePointTypeOptions(choices, value) {
            servicePointTypesSelect.empty();

            if (productsSelect.val() === 'service_point') {
                servicePointTypesSelect.parent().parent().show();
            } else {
                servicePointTypesSelect.parent().parent().hide();
                return;
            }

            for (const [text, value] of Object.entries(choices)) {
                servicePointTypesSelect.append($('<option></option>').attr('value', value).text(text));
            }

            servicePointTypesSelect.val(value ?? null);
        }

        async function rerenderForm() {
            const isServicePointDelivery = productsSelect.val() === 'service_point';

            if (isServicePointDelivery) {
                carrierProductsSelect.parent().parent().show();
                servicePointTypesSelect.parent().parent().show();
            } else {
                carrierProductsSelect.parent().parent().hide();
                servicePointTypesSelect.parent().parent().hide();
            }

            carriersSelect.attr('disabled', true);
            productsSelect.attr('disabled', true);
            carrierProductsSelect.attr('disabled', true);
            servicePointTypesSelect.attr('disabled', true);

            await fetchCarrierFields()
                .then((data) => {
                    updateProductCodeOptions(data?.choices?.product_code, data?.default?.product_code);
                    updateCarrierProductCodeOptions(
                        data?.choices?.carrier_product_code,
                        data?.default?.carrier_product_code,
                    );
                    updateServicePointTypeOptions(
                        data?.choices?.service_point_types,
                        data?.default?.service_point_types,
                    );
                })
                .catch((error) => {
                    console.error(error);
                    return null;
                });

            carriersSelect.attr('disabled', false);
            productsSelect.attr('disabled', false);
            carrierProductsSelect.attr('disabled', false);
            servicePointTypesSelect.attr('disabled', false);
        }

        carriersSelect.on('change', rerenderForm);
        productsSelect.on('change', rerenderForm);
        carrierProductsSelect.on('change', rerenderForm);

        carriersSelect.trigger('change');
    </script>
{% endblock %}
